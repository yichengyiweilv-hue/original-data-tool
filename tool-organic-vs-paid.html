<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è‡ªç„¶é‡ & ä¹°é‡ Excel â†’ JS æ•°æ®è½¬æ¢å·¥å…· (v4.3 æ— æ‹¬å·ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f3f5f9;
      --card: #ffffff;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-sub: #64748b;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      background: var(--bg);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: var(--text-main);
    }
    .container { max-width: 1000px; margin: 0 auto; }
    
    .header { margin-bottom: 24px; text-align: center; }
    .header h1 {
      font-size: 24px; font-weight: 700; margin: 0 0 8px 0;
      background: linear-gradient(135deg, #2563eb, #16a34a);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header p { font-size: 13px; color: var(--text-sub); margin: 0; }

    .card {
      background: var(--card); border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      padding: 20px; margin-bottom: 20px;
    }
    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
    }
    .card-title { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px; }
    .tag { 
      font-size: 11px; padding: 2px 8px; border-radius: 99px; 
      background: #eff6ff; color: #2563eb; font-weight: 500;
    }
    
    .control-row {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px;
    }
    input[type="file"] {
      font-size: 12px; padding: 8px;
      border: 1px dashed var(--border); border-radius: 6px;
      background: #f8fafc; flex: 1; min-width: 200px;
    }
    button {
      padding: 8px 16px; border-radius: 6px; border: none;
      font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-gen { background: var(--accent); color: white; }
    .btn-gen:hover { background: var(--accent-hover); }
    .btn-copy { background: #f1f5f9; color: var(--text-main); }
    .btn-copy:hover { background: #e2e8f0; }

    textarea {
      width: 100%; height: 220px;
      border: 1px solid var(--border); border-radius: 8px;
      padding: 12px; font-family: 'Menlo', 'Monaco', monospace;
      font-size: 11px; line-height: 1.5; color: #334155;
      background: #f8fafc; resize: vertical; outline: none;
    }
    textarea:focus { border-color: var(--accent); background: #fff; }

    .tips {
      font-size: 11px; color: #94a3b8; margin-top: 8px; line-height: 1.6;
      background: #f8fafc; padding: 8px 12px; border-radius: 6px;
    }
    code { background: #e2e8f0; padding: 1px 4px; border-radius: 4px; color: #0f172a; }
  </style>
</head>
<body>

<div class="container">
  <header class="header">
    <h1>BangBet æ•°æ®è½¬æ¢å·¥å…· v4.3</h1>
    <p>Excel æºæ•°æ® (English Header) â†’ çº¯å¯¹è±¡åˆ—è¡¨ (No Brackets)</p>
  </header>

  <section class="card">
    <div class="card-header">
      <div class="card-title">
        <span>ğŸŒ¿ è‡ªç„¶é‡ (Organic)</span>
        <span class="tag">Format: {...}, {...}</span>
      </div>
      <button class="btn-copy" id="copy-org">å¤åˆ¶è‡ªç„¶é‡ä»£ç </button>
    </div>
    
    <div class="control-row">
      <input type="file" id="file-org" accept=".xlsx, .xls, .csv" />
      <button class="btn-gen" id="gen-org">ç”Ÿæˆè‡ªç„¶é‡ JS</button>
    </div>
    
    <textarea id="out-org" placeholder="// æ­¥éª¤ 1ï¼šä¸Šä¼ ã€è‡ªç„¶é‡æ•°æ®.xlsxã€‘
// æ­¥éª¤ 2ï¼šç‚¹å‡»ã€Œç”Ÿæˆè‡ªç„¶é‡ JSã€
// æ­¥éª¤ 3ï¼šç›´æ¥å¤åˆ¶ï¼Œè¿½åŠ ç²˜è´´åˆ° data.js æ•°ç»„æœ«å°¾"></textarea>

    <div class="tips">
      <strong>æ›´æ–°ï¼š</strong> è¾“å‡ºå·²å»é™¤å¤–å±‚ <code>[]</code>ï¼Œä»…ç”Ÿæˆä»¥é€—å·åˆ†éš”çš„å¯¹è±¡åˆ—è¡¨ï¼Œæ–¹ä¾¿ç›´æ¥è¿½åŠ åˆ°ç°æœ‰æ•°ç»„ä¸­ã€‚
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div class="card-title">
        <span>ğŸ’° ä¹°é‡ (Paid)</span>
        <span class="tag">Format: {...}, {...}</span>
      </div>
      <button class="btn-copy" id="copy-paid">å¤åˆ¶ä¹°é‡ä»£ç </button>
    </div>
    
    <div class="control-row">
      <input type="file" id="file-paid" accept=".xlsx, .xls, .csv" />
      <button class="btn-gen" id="gen-paid">ç”Ÿæˆä¹°é‡ JS</button>
    </div>
    
    <textarea id="out-paid" placeholder="// æ­¥éª¤ 1ï¼šä¸Šä¼ ã€ä¹°é‡æ•°æ®.xlsxã€‘
// æ­¥éª¤ 2ï¼šç‚¹å‡»ã€Œç”Ÿæˆä¹°é‡ JSã€
// æ­¥éª¤ 3ï¼šç›´æ¥å¤åˆ¶ï¼Œè¿½åŠ ç²˜è´´åˆ° data.js æ•°ç»„æœ«å°¾"></textarea>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(function() {
  // ================= å·¥å…·å‡½æ•° =================
  function formatNum(val) {
    if (val === null || val === undefined || val === '') return 0;
    const n = Number(val);
    return Number.isNaN(n) ? 0 : Number(n.toFixed(2).replace(/\.00$/, ''));
  }

  function formatDate(val) {
    if (!val) return null;
    if (typeof val === 'number') {
      const date = XLSX.SSF.parse_date_code(val);
      if (date) {
        return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
      }
    }
    return String(val).trim(); 
  }

  function findColIndex(headers, key) {
    if (!headers || !key) return -1;
    const search = key.toLowerCase().trim();
    return headers.findIndex(h => String(h).toLowerCase().trim() === search);
  }

  // ================= æ ¸å¿ƒè½¬æ¢é€»è¾‘ =================
  
  // 1. è‡ªç„¶é‡è½¬æ¢
  function processOrganic(data) {
    if (!data || data.length < 2) return "// Excel æ— æ•°æ®";
    
    const headers = data[0];
    const rows = data.slice(1);
    const result = [];

    const targetFields = [
      "date", "country", "registration",
      "D0_unique_purchase", "D0_PURCHASE_VALUE",
      "D0_TOTAL_BET_PLACED_USER", "D0_SPORTS_BET_PLACED_USER", "D0_GAMES_BET_PLACED_USER",
      "D0_SPORTS_BET_FLOW", "D0_GAMES_BET_FLOW", "D0_TOTAL_BET_FLOW",
      "D7_unique_purchase", "D7_PURCHASE_VALUE",
      "D7_TOTAL_BET_PLACED_USER", "D7_SPORTS_BET_PLACED_USER", "D7_GAMES_BET_PLACED_USER",
      "D7_SPORTS_BET_FLOW", "D7_GAMES_BET_FLOW", "D7_TOTAL_BET_FLOW",
      "D1_retained_users", "D7_retained_users"
    ];

    const colMap = {};
    targetFields.forEach(f => colMap[f] = findColIndex(headers, f));

    if (colMap.date === -1 || colMap.country === -1) {
      return `// âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° date æˆ– country åˆ—ã€‚\n// è¯»å–åˆ°çš„è¡¨å¤´ï¼š${headers.join(', ')}`;
    }

    rows.forEach(row => {
      const dateVal = formatDate(row[colMap.date]);
      if (!dateVal || !dateVal.match(/^\d{4}-\d{2}-\d{2}/)) return;

      const monthKey = dateVal.slice(0, 7);
      const country = row[colMap.country] ? String(row[colMap.country]).trim().toUpperCase() : "";

      let itemStr = `  {
    month: "${monthKey}",
    date: "${dateVal}",
    country: "${country}",`;
      
      targetFields.forEach(field => {
        if (field === 'date' || field === 'country') return;
        const val = colMap[field] > -1 ? formatNum(row[colMap[field]]) : 0;
        itemStr += `\n    ${field}: ${val},`;
      });

      itemStr += `\n  }`;
      result.push({ date: dateVal, str: itemStr });
    });

    result.sort((a, b) => a.date.localeCompare(b.date));
    if (result.length === 0) return "// æœªæå–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ Excel æ—¥æœŸæ ¼å¼";
    
    // ã€æ”¹åŠ¨ç‚¹ã€‘åªè¿”å› join åçš„å­—ç¬¦ä¸²ï¼Œä¸åŠ  []
    return result.map(i => i.str).join(',\n') + ','; // æœ«å°¾åŠ ä¸ªé€—å·æ–¹ä¾¿åç»­ç²˜è´´
  }

  // 2. ä¹°é‡è½¬æ¢
  function processPaid(data) {
    if (!data || data.length < 2) return "// Excel æ— æ•°æ®";
    
    const headers = data[0];
    const rows = data.slice(1);
    const result = [];

    const targetFields = [
      "date", "country", "media", "Product_type", "spent",
      "registration",
      "D0_unique_purchase", "D0_PURCHASE_VALUE",
      "D0_TOTAL_BET_PLACED_USER", "D0_SPORTS_BET_PLACED_USER", "D0_GAMES_BET_PLACED_USER",
      "D0_SPORTS_BET_FLOW", "D0_GAMES_BET_FLOW", "D0_TOTAL_BET_FLOW",
      "D7_unique_purchase", "D7_PURCHASE_VALUE",
      "D7_TOTAL_BET_PLACED_USER", "D7_SPORTS_BET_PLACED_USER", "D7_GAMES_BET_PLACED_USER",
      "D7_SPORTS_BET_FLOW", "D7_GAMES_BET_FLOW", "D7_TOTAL_BET_FLOW",
      "D1_retained_users", "D7_retained_users"
    ];

    const colMap = {};
    targetFields.forEach(f => colMap[f] = findColIndex(headers, f));

    if (colMap.date === -1) return `// âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° date åˆ—`;

    rows.forEach(row => {
      const dateVal = formatDate(row[colMap.date]);
      if (!dateVal || !dateVal.match(/^\d{4}-\d{2}-\d{2}/)) return;

      const monthKey = dateVal.slice(0, 7);
      const country = colMap.country > -1 ? String(row[colMap.country]).trim().toUpperCase() : "";
      const media = colMap.media > -1 ? String(row[colMap.media]).trim() : "";
      const pType = colMap.Product_type > -1 ? String(row[colMap.Product_type]).trim() : "";

      let itemStr = `  {
    month: "${monthKey}",
    date: "${dateVal}",
    country: "${country}",
    media: "${media}",
    productType: "${pType}",`;
      
      targetFields.forEach(field => {
        if (["date", "country", "media", "Product_type"].includes(field)) return;
        let jsKey = field;
        if (field === "spent") jsKey = "spend"; 

        const val = colMap[field] > -1 ? formatNum(row[colMap[field]]) : 0;
        itemStr += `\n    ${jsKey}: ${val},`;
      });

      itemStr += `\n  }`;
      result.push({ date: dateVal, str: itemStr });
    });

    result.sort((a, b) => a.date.localeCompare(b.date));
    if (result.length === 0) return "// æœªæå–åˆ°æœ‰æ•ˆæ•°æ®";
    
    // ã€æ”¹åŠ¨ç‚¹ã€‘åªè¿”å› join åçš„å­—ç¬¦ä¸²ï¼Œä¸åŠ  []
    return result.map(i => i.str).join(',\n') + ','; // æœ«å°¾åŠ ä¸ªé€—å·
  }

  // ================= äº‹ä»¶ç»‘å®š =================
  function handleFile(fileInputId, outputId, processor) {
    const input = document.getElementById(fileInputId);
    const output = document.getElementById(outputId);
    if (!input.files.length) {
      alert("è¯·å…ˆé€‰æ‹© Excel æ–‡ä»¶");
      return;
    }
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, {header: 1});
        output.value = processor(json);
      } catch (err) {
        output.value = "// âŒ è§£æå‡ºé”™ï¼š" + err.message;
      }
    };
    reader.readAsArrayBuffer(file);
  }

  document.getElementById('gen-org').onclick = () => handleFile('file-org', 'out-org', processOrganic);
  document.getElementById('gen-paid').onclick = () => handleFile('file-paid', 'out-paid', processPaid);

  function copyToClipboard(id) {
    const el = document.getElementById(id);
    el.select();
    document.execCommand('copy');
    const btn = id === 'out-org' ? document.getElementById('copy-org') : document.getElementById('copy-paid');
    const originBtnText = btn.innerText;
    btn.innerText = 'âœ… å·²å¤åˆ¶';
    setTimeout(() => btn.innerText = originBtnText, 1500);
  }

  document.getElementById('copy-org').onclick = () => copyToClipboard('out-org');
  document.getElementById('copy-paid').onclick = () => copyToClipboard('out-paid');

})();
</script>

</body>
</html>
