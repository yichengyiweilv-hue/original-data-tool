<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to JS Code Generator (Organic & Paid)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        h1 { text-align: center; color: #333; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 450px; }
        .card h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #444; }
        .upload-area { border: 2px dashed #ccc; padding: 30px; text-align: center; margin-bottom: 20px; border-radius: 4px; transition: border-color 0.3s; }
        .upload-area:hover { border-color: #666; }
        textarea { width: 100%; height: 400px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; background-color: #2d2d2d; color: #f8f8f2; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        .copy-btn { background-color: #28a745; float: right; }
        .copy-btn:hover { background-color: #218838; }
        .status { margin-top: 10px; color: #666; font-size: 13px; }
        .error { color: #dc3545; }
    </style>
</head>
<body>

    <h1>Excel 数据转 JS 代码工具</h1>

    <div class="container">
        <div class="card">
            <h2>1. 自然量 (Organic Data)</h2>
            <div class="upload-area">
                <p>上传自然量 Excel / CSV 文件</p>
                <input type="file" id="organicFile" accept=".xlsx, .xls, .csv" />
            </div>
            <div id="organicStatus" class="status">等待上传...</div>
            <textarea id="organicOutput" placeholder="生成的代码将显示在这里..." readonly></textarea>
            <button onclick="copyToClipboard('organicOutput')" class="copy-btn">一键复制</button>
        </div>

        <div class="card">
            <h2>2. 买量 (Paid Data)</h2>
            <div class="upload-area">
                <p>上传买量 Excel / CSV 文件</p>
                <input type="file" id="paidFile" accept=".xlsx, .xls, .csv" />
            </div>
            <div id="paidStatus" class="status">等待上传...</div>
            <textarea id="paidOutput" placeholder="生成的代码将显示在这里..." readonly></textarea>
            <button onclick="copyToClipboard('paidOutput')" class="copy-btn">一键复制</button>
        </div>
    </div>

    <script>
        // 定义需要提取的字段及其类型（s=string, n=number）
        // 如果 Excel 列名与 JS key 一致，直接写 key；如果不一致，需要处理（在代码逻辑中处理 Product_type -> productType）
        
        const ORGANIC_FIELDS = [
            'registration', 'D0_unique_purchase', 'D7_unique_purchase', 
            'D0_PURCHASE_VALUE', 'D7_PURCHASE_VALUE',
            'D0_TOTAL_BET_PLACED_USER', 'D7_TOTAL_BET_PLACED_USER',
            'D0_SPORTS_BET_PLACED_USER', 'D0_GAMES_BET_PLACED_USER', 'D7_SPORTS_BET_PLACED_USER', 'D7_GAMES_BET_PLACED_USER',
            'D0_SPORTS_BET_FLOW', 'D0_GAMES_BET_FLOW', 'D0_TOTAL_BET_FLOW',
            'D7_SPORTS_BET_FLOW', 'D7_GAMES_BET_FLOW', 'D7_TOTAL_BET_FLOW',
            'D1_retained_users', 'D7_retained_users'
        ];

        const PAID_FIELDS = [
            'spent', // spent 放在 registration 前面
            'registration', 'D0_unique_purchase', 'D7_unique_purchase',
            'D0_PURCHASE_VALUE', 'D7_PURCHASE_VALUE',
            'D0_TOTAL_BET_PLACED_USER', 'D7_TOTAL_BET_PLACED_USER',
            'D0_SPORTS_BET_PLACED_USER', 'D0_GAMES_BET_PLACED_USER', 'D7_SPORTS_BET_PLACED_USER', 'D7_GAMES_BET_PLACED_USER',
            'D0_SPORTS_BET_FLOW', 'D0_GAMES_BET_FLOW', 'D0_TOTAL_BET_FLOW',
            'D7_SPORTS_BET_FLOW', 'D7_GAMES_BET_FLOW', 'D7_TOTAL_BET_FLOW',
            'D1_retained_users', 'D7_retained_users'
        ];

        // 监听文件上传
        document.getElementById('organicFile').addEventListener('change', (e) => handleFile(e, 'organic'));
        document.getElementById('paidFile').addEventListener('change', (e) => handleFile(e, 'paid'));

        function handleFile(event, type) {
            const file = event.target.files[0];
            const statusElem = document.getElementById(type + 'Status');
            const outputElem = document.getElementById(type + 'Output');

            if (!file) return;

            statusElem.textContent = "正在处理...";
            statusElem.className = "status";

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // 假设数据在第一个 Sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 将 Sheet 转为 JSON 对象数组
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    if (jsonData.length === 0) {
                        throw new Error("文件为空或无法解析");
                    }

                    // 生成代码
                    let codeOutput = "";
                    
                    jsonData.forEach(row => {
                        // 简单的日期过滤，防止空行
                        if (!row.date && !row.Date) return;

                        // 统一日期格式 (如果是 Excel 日期序列号转 YYYY-MM-DD，如果是字符串则保留)
                        let dateStr = row.date || row.Date;
                        // 注意：这里假设输入已经是字符串格式 "2025-10-01" 或类似的。
                        // 如果 Excel 解析出来是数字（Excel日期格式），可能需要转换，但通常 CSV 上传是字符串。

                        // 统一国家大写
                        let countryStr = (row.country || row.Country || "").toUpperCase();

                        let lineObj = [];

                        // 1. 添加基础字段
                        lineObj.push(`date: "${dateStr}"`);
                        lineObj.push(`country: "${countryStr}"`);

                        // 2. 如果是买量，添加额外基础字段
                        if (type === 'paid') {
                            let media = row.media || row.Media || "";
                            let productType = row.Product_type || row.productType || row.product_type || "app"; // 处理表头映射
                            lineObj.push(`media: "${media}"`);
                            lineObj.push(`productType: "${productType}"`);
                        }

                        // 3. 循环处理数值字段
                        const targetFields = type === 'organic' ? ORGANIC_FIELDS : PAID_FIELDS;
                        
                        targetFields.forEach(field => {
                            let val = row[field];
                            // 如果 Excel 表头是全大写或小写不一致，可以在这里做兼容查找
                            // 暂时假设表头和需要的字段名一致（正如您提供的附件所示）
                            
                            // 确保是数字，如果为空则设为0，或者根据需求不显示
                            // 这里我们处理成：如果有值则显示数字，无值显示空或0
                            let numVal = parseFloat(val);
                            if (isNaN(numVal)) {
                                // 尝试查找其他可能的大小写组合? 或者直接忽略
                                // 这里假设源数据如果为空，JS代码中是否需要该字段？
                                // 按照模版，通常如果为0或空，JS里也可以写0
                                numVal = 0; 
                            }
                            
                            // 保留最多2位小数 (针对金额/流水)，整数则保持整数
                            // 简单的处理方式：
                            let displayVal = Number.isInteger(numVal) ? numVal : parseFloat(numVal.toFixed(2));
                            
                            lineObj.push(`${field}: ${displayVal}`);
                        });

                        // 组合成一行代码
                        codeOutput += `    { ${lineObj.join(', ')} },\n`;
                    });

                    outputElem.value = codeOutput;
                    statusElem.textContent = `成功生成 ${jsonData.length} 条数据的代码`;
                    statusElem.style.color = "green";

                } catch (err) {
                    console.error(err);
                    statusElem.textContent = "解析错误: " + err.message;
                    statusElem.className = "status error";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999); /* For mobile devices */
            document.execCommand("copy");
            alert("代码已复制到剪贴板！");
        }
    </script>
</body>
</html>
