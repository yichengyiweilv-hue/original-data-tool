<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangbet Data Parser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #00f3ff; /* 科技蓝 */
            --bg-color: #0b1120;      /* 深空黑 */
            --card-bg: rgba(23, 37, 84, 0.8); /* 半透明深蓝 */
            --text-color: #e2e8f0;
            --border-color: #2563eb;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.05) 0%, transparent 20%);
            color: var(--text-color);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 40px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            font-weight: 700;
        }

        .container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            flex: 1;
            min-width: 480px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .card h2::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 8px var(--primary-color);
        }

        .upload-area {
            border: 2px dashed rgba(37, 99, 235, 0.5);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
            box-shadow: inset 0 0 15px rgba(37, 99, 235, 0.2);
        }

        .upload-area p {
            margin: 0 0 10px;
            color: #94a3b8;
        }

        input[type="file"] {
            color: var(--text-color);
            font-size: 0.9rem;
        }

        /* 强制代码框为白色背景，黑色文字 */
        textarea {
            width: 100%;
            height: 450px;
            background-color: #ffffff; 
            color: #000000;
            border: 2px solid #334155;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            resize: vertical;
            box-sizing: border-box;
            outline: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        textarea:focus {
            border-color: var(--primary-color);
        }

        .actions {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 1px solid #3b82f6;
        }

        button:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.5);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(1px);
        }

        .status {
            font-size: 13px;
            color: #94a3b8;
            flex-grow: 1;
        }
        
        .success-msg {
            color: #4ade80; /* 绿色 */
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .success-msg.show {
            opacity: 1;
        }

    </style>
</head>
<body>

    <h1>Bangbet Data Parser Tool</h1>

    <div class="container">
        <div class="card">
            <h2>自然量 (Organic)</h2>
            <div class="upload-area" onclick="document.getElementById('organicFile').click()">
                <p>点击或拖拽上传 Excel / CSV</p>
                <input type="file" id="organicFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFile(event, 'organic')"/>
                <span style="font-size:12px; color:var(--primary-color); text-decoration:underline;">选择文件...</span>
            </div>
            <textarea id="organicOutput" placeholder="// 等待数据解析..." readonly></textarea>
            <div class="actions">
                <span id="organicStatus" class="status">等待上传...</span>
                <span id="organicCopyMsg" class="success-msg">已复制!</span>
                <button onclick="copyToClipboard('organicOutput', 'organicCopyMsg')">一键复制</button>
            </div>
        </div>

        <div class="card">
            <h2>买量 (Paid)</h2>
            <div class="upload-area" onclick="document.getElementById('paidFile').click()">
                <p>点击或拖拽上传 Excel / CSV</p>
                <input type="file" id="paidFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFile(event, 'paid')"/>
                <span style="font-size:12px; color:var(--primary-color); text-decoration:underline;">选择文件...</span>
            </div>
            <textarea id="paidOutput" placeholder="// 等待数据解析..." readonly></textarea>
            <div class="actions">
                <span id="paidStatus" class="status">等待上传...</span>
                <span id="paidCopyMsg" class="success-msg">已复制!</span>
                <button onclick="copyToClipboard('paidOutput', 'paidCopyMsg')">一键复制</button>
            </div>
        </div>
    </div>

    <script>
        const ORGANIC_FIELDS = [
            'registration', 'D0_unique_purchase', 'D7_unique_purchase', 
            'D0_PURCHASE_VALUE', 'D7_PURCHASE_VALUE',
            'D0_TOTAL_BET_PLACED_USER', 'D7_TOTAL_BET_PLACED_USER',
            'D0_SPORTS_BET_PLACED_USER', 'D0_GAMES_BET_PLACED_USER', 'D7_SPORTS_BET_PLACED_USER', 'D7_GAMES_BET_PLACED_USER',
            'D0_SPORTS_BET_FLOW', 'D0_GAMES_BET_FLOW', 'D0_TOTAL_BET_FLOW',
            'D7_SPORTS_BET_FLOW', 'D7_GAMES_BET_FLOW', 'D7_TOTAL_BET_FLOW',
            'D1_retained_users', 'D7_retained_users'
        ];

        const PAID_FIELDS = [
            'spent', 
            'registration', 'D0_unique_purchase', 'D7_unique_purchase',
            'D0_PURCHASE_VALUE', 'D7_PURCHASE_VALUE',
            'D0_TOTAL_BET_PLACED_USER', 'D7_TOTAL_BET_PLACED_USER',
            'D0_SPORTS_BET_PLACED_USER', 'D0_GAMES_BET_PLACED_USER', 'D7_SPORTS_BET_PLACED_USER', 'D7_GAMES_BET_PLACED_USER',
            'D0_SPORTS_BET_FLOW', 'D0_GAMES_BET_FLOW', 'D0_TOTAL_BET_FLOW',
            'D7_SPORTS_BET_FLOW', 'D7_GAMES_BET_FLOW', 'D7_TOTAL_BET_FLOW',
            'D1_retained_users', 'D7_retained_users'
        ];

        // 日期格式化函数：确保输出 YYYY-MM-DD
        function formatDate(inputDate) {
            if (!inputDate) return "";
            
            // 1. 如果是 Excel 序列号 (数字)
            if (typeof inputDate === 'number') {
                const dateObj = XLSX.SSF.parse_date_code(inputDate);
                const y = dateObj.y;
                const m = String(dateObj.m).padStart(2, '0');
                const d = String(dateObj.d).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            // 2. 如果是字符串，尝试解析
            let str = String(inputDate).trim();
            // 如果已经是 YYYY-MM-DD 格式，直接返回
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
            
            // 尝试处理 "2025/10/1" 或其他格式
            const d = new Date(str);
            if (!isNaN(d.getTime())) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 无法解析则原样返回
            return str;
        }

        function handleFile(event, type) {
            const file = event.target.files[0];
            const statusElem = document.getElementById(type + 'Status');
            const outputElem = document.getElementById(type + 'Output');

            if (!file) return;

            statusElem.textContent = "解析中...";
            statusElem.style.color = "#94a3b8";

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true}); // cellDates: true 尝试识别日期
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 获取原生 JSON 数据
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    if (jsonData.length === 0) {
                        throw new Error("文件为空");
                    }

                    let codeOutput = "";
                    
                    jsonData.forEach(row => {
                        // 兼容大小写 Key
                        const getVal = (keys) => {
                            for (let k of keys) {
                                if (row[k] !== undefined) return row[k];
                            }
                            return undefined;
                        };

                        let rawDate = getVal(['date', 'Date', 'DATE']);
                        if (!rawDate) return; // 跳过无日期行

                        let dateStr = formatDate(rawDate);
                        let countryStr = String(getVal(['country', 'Country', 'COUNTRY']) || "").toUpperCase();

                        let lineObj = [];
                        lineObj.push(`date: "${dateStr}"`);
                        lineObj.push(`country: "${countryStr}"`);

                        if (type === 'paid') {
                            let media = getVal(['media', 'Media']) || "";
                            let pType = getVal(['Product_type', 'productType', 'product_type', 'ProductType']) || "app";
                            lineObj.push(`media: "${media}"`);
                            lineObj.push(`productType: "${pType}"`);
                        }

                        const targetFields = type === 'organic' ? ORGANIC_FIELDS : PAID_FIELDS;
                        
                        targetFields.forEach(field => {
                            let val = row[field];
                            let numVal = parseFloat(val);
                            if (isNaN(numVal)) numVal = 0;
                            // 保留数值精度：如果是整数显示整数，浮点数保留2位
                            let displayVal = Number.isInteger(numVal) ? numVal : parseFloat(numVal.toFixed(2));
                            lineObj.push(`${field}: ${displayVal}`);
                        });

                        codeOutput += `    { ${lineObj.join(', ')} },\n`;
                    });

                    outputElem.value = codeOutput;
                    statusElem.textContent = `生成成功: ${jsonData.length} 条数据`;
                    statusElem.style.color = "#4ade80";

                } catch (err) {
                    console.error(err);
                    statusElem.textContent = "错误: " + err.message;
                    statusElem.style.color = "#ef4444";
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function copyToClipboard(elementId, msgId) {
            const copyText = document.getElementById(elementId);
            if (!copyText.value) return;
            
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            
            try {
                document.execCommand("copy");
                // 显示复制成功提示（非弹窗）
                const msgElem = document.getElementById(msgId);
                msgElem.classList.add('show');
                setTimeout(() => {
                    msgElem.classList.remove('show');
                }, 2000);
            } catch (err) {
                console.error("复制失败", err);
            }
        }
    </script>
</body>
</html>
