<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>自然量 & 买量 Excel → JS 源数据转换工具</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --border: #e5e7eb;
      --border-soft: #d1d5db;
      --text-main: #111827;
      --text-sub: #6b7280;
      --accent: #0ea5e9;
      --accent-soft: rgba(14,165,233,0.08);
      --accent-strong: #0284c7;
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC",
        "Microsoft Yahei",sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 16px;
      padding: 16px 18px 12px;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      background: radial-gradient(circle at top left,#eff6ff 0,#e0f2fe 40%,#f9fafb 100%);
      box-shadow: 0 10px 24px rgba(148,163,184,0.35);
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .header-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .header-note {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .badge-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #cbd5f5;
      background: #eef2ff;
      color: #4f46e5;
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 14px;
    }

    @media (max-width: 960px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: 0 6px 18px rgba(15,23,42,0.06);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 260px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      color: #111827;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .file-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .file-input {
      font-size: 11px;
      color: var(--text-main);
    }

    input[type="file"] {
      max-width: 260px;
    }

    .btn-copy,
    .btn-generate {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
    }

    .btn-copy {
      border-color: var(--border-soft);
      color: var(--text-sub);
      background: #f9fafb;
    }

    .btn-copy:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .btn-generate {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .btn-generate:hover {
      background: rgba(14,165,233,0.16);
      border-color: var(--accent-strong);
    }

    .output {
      flex: 1;
      min-height: 200px;
      margin-top: 4px;
    }

    textarea {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      color: var(--text-main);
      font-size: 11px;
      padding: 8px;
      resize: vertical;
      font-family: Menlo, Consolas, "SF Mono", monospace;
      line-height: 1.5;
      outline: none;
      white-space: pre;
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    .hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.5;
    }

    .hint strong {
      color: #111827;
    }

    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
      border-top: 1px dashed var(--border-soft);
      padding-top: 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="header-title">自然量 & 买量 Excel → JS 源数据转换工具</div>
      <div class="header-sub">
        上传 Excel 后，点击「生成 code」，得到可以直接粘贴到 <code>RAW_ORGANIC_BY_MONTH</code> /
        <code>RAW_PAID_BY_MONTH</code> 的 <code>"YYYY-MM": [ {{...}} ]</code> 片段。
      </div>
      <div class="header-note">
        · 自然量：sheet 名默认 <strong>zrl_country_monthly</strong>，第 1 行是表头（含 <code>date</code> / <code>country</code> / <code>注册人数</code> 等），第 2 行为英文字段说明会被自动过滤。<br />
        · 买量：sheet 名默认 <strong>Sheet1</strong>，第 1 行为英文字段表头（含 <code>date</code> / <code>country</code> / <code>media</code> / <code>Product_type</code> / <code>spent</code> 等）。<br />
        · 输出片段形态示例：<code>"2025-10": [ { date: "2025-10-01", country: "GH", ... } ]</code>。
      </div>
      <div class="badge-row">
        <span class="badge">白色主题 · 纯前端 · 无需安装软件</span>
        <span class="badge">输出格式对齐你现有看板</span>
      </div>
    </header>

    <main class="main-grid">
      <!-- 自然量 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">自然量 Excel → JS 片段</div>
            <div class="card-sub">
              输出格式：<code>"YYYY-MM": [ { date: "...", country: "GH", ... } ]</code>，直接粘贴到 <code>RAW_ORGANIC_BY_MONTH</code> 内部。
            </div>
          </div>
          <button type="button" class="btn-copy" id="copy-org">复制自然量 code</button>
        </div>

        <div class="file-row">
          <span>自然量 Excel：</span>
          <input type="file" id="organic-file" class="file-input" accept=".xlsx,.xls" />
          <button type="button" class="btn-generate" id="gen-org">生成自然量 code</button>
        </div>
        <div class="hint">
          · 要求：表头包含 <strong>date</strong> / <strong>country</strong> / <strong>注册人数</strong> / <strong>D0充值人数</strong> / <strong>D0体育流水</strong> 等列。<br />
          · 如一个文件包含多个月，会按日期自动拆分成多段 <code>"YYYY-MM": [ ... ]</code>。
        </div>
        <div class="output">
          <textarea id="organic-output" placeholder='上传自然量 Excel 后，点击「生成自然量 code」，这里会生成类似：

// ===== 2025-10 自然量（粘贴到 RAW_ORGANIC_BY_MONTH 对象里） =====
"2025-10": [
  {
    date: "2025-10-01",
    country: "GH",
    registration: 100,
    D0_unique_purchase: 20,
    D7_unique_purchase: 28,
    D0_PURCHASE_VALUE: 150.0,
    D7_PURCHASE_VALUE: 380.0,
    D0_TOTAL_BET_PLACED_USER: 35,
    D7_TOTAL_BET_PLACED_USER: 48,
    D0_SPORTS_BET_PLACED_USER: 12,
    D0_GAMES_BET_PLACED_USER: 30,
    D7_SPORTS_BET_PLACED_USER: 16,
    D7_GAMES_BET_PLACED_USER: 40,
    D0_SPORTS_BET_FLOW: 90.0,
    D0_GAMES_BET_FLOW: 210.0,
    D0_TOTAL_BET_FLOW: 300.0,
    D7_SPORTS_BET_FLOW: 260.0,
    D7_GAMES_BET_FLOW: 1220.0,
    D7_TOTAL_BET_FLOW: 1480.0,
    D1_retained_users: 60,
    D7_retained_users: 32
  }
  // ... 其他日期 × 国家
]'></textarea>
        </div>
      </section>

      <!-- 买量 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">买量 Excel → JS 片段</div>
            <div class="card-sub">
              输出格式：<code>"YYYY-MM": [ { date: "...", media: "FB", productType: "app", ... } ]</code>，直接粘贴到 <code>RAW_PAID_BY_MONTH</code> 内部。
            </div>
          </div>
          <button type="button" class="btn-copy" id="copy-paid">复制买量 code</button>
        </div>

        <div class="file-row">
          <span>买量 Excel：</span>
          <input type="file" id="paid-file" class="file-input" accept=".xlsx,.xls" />
          <button type="button" class="btn-generate" id="gen-paid">生成买量 code</button>
        </div>
        <div class="hint">
          · 要求：表头至少包含 <strong>date</strong> / <strong>country</strong> / <strong>media</strong> / <strong>Product_type</strong> / <strong>spent</strong> 等列。<br />
          · 输出字段包括：<code>date</code>、<code>country</code>、<code>media</code>、<code>productType</code>、<code>spent</code>、D0/D7 指标和 <code>total_ggr</code> / <code>sports_ggr</code> / <code>games_ggr</code>。
        </div>
        <div class="output">
          <textarea id="paid-output" placeholder='上传买量 Excel 后，点击「生成买量 code」，这里会生成类似：

// ===== 2025-10 买量（粘贴到 RAW_PAID_BY_MONTH 对象里） =====
"2025-10": [
  {
    date: "2025-10-01",
    country: "GH",
    media: "FB",
    productType: "app",
    spent: 500.0,
    registration: 200,
    D0_unique_purchase: 45,
    D7_unique_purchase: 70,
    D0_PURCHASE_VALUE: 220.0,
    D7_PURCHASE_VALUE: 780.0,
    D0_TOTAL_BET_PLACED_USER: 60,
    D7_TOTAL_BET_PLACED_USER: 90,
    D0_SPORTS_BET_PLACED_USER: 25,
    D0_GAMES_BET_PLACED_USER: 50,
    D7_SPORTS_BET_PLACED_USER: 32,
    D7_GAMES_BET_PLACED_USER: 72,
    D0_SPORTS_BET_FLOW: 160.0,
    D0_GAMES_BET_FLOW: 330.0,
    D0_TOTAL_BET_FLOW: 490.0,
    D7_SPORTS_BET_FLOW: 420.0,
    D7_GAMES_BET_FLOW: 1830.0,
    D7_TOTAL_BET_FLOW: 2250.0,
    D1_retained_users: 80,
    D7_retained_users: 44,
    total_ggr: 0,
    sports_ggr: 0,
    games_ggr: 0
  }
  // ... 其他日期 × 国家 × 媒体 / 产品
]'></textarea>
        </div>
      </section>
    </main>

    <footer class="footer">
      使用建议：每月导出自然量 / 买量 Excel 后，用本页面生成对应月份的 JS 片段，直接粘贴到各看板的数据源区域。
    </footer>
  </div>

  <!-- XLSX 解析库：在线 CDN，免安装 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    function formatJsNumber(value) {
      if (value === null || value === undefined || value === "") return "0";
      var num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (Math.abs(num - Math.round(num)) < 1e-9) {
        return String(Math.round(num));
      }
      return num.toFixed(2).replace(/\\.00$/, "");
    }

    function normalizeDateCell(v) {
      if (v === null || v === undefined || v === "") return null;

      if (v instanceof Date) {
        var y = v.getFullYear();
        var m = String(v.getMonth() + 1).padStart(2, "0");
        var d = String(v.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + d;
      }

      if (typeof v === "number") {
        if (typeof XLSX !== "undefined" && XLSX.SSF && XLSX.SSF.parse_date_code) {
          var o = XLSX.SSF.parse_date_code(v);
          if (o && o.y && o.m && o.d) {
            var y2 = o.y;
            var m2 = String(o.m).padStart(2, "0");
            var d2 = String(o.d).padStart(2, "0");
            return y2 + "-" + m2 + "-" + d2;
          }
        }
      }

      if (typeof v === "string") {
        var m = v.match(/(\\d{4})[-/](\\d{1,2})[-/](\\d{1,2})/);
        if (m) {
          var y3 = m[1];
          var m3 = String(parseInt(m[2], 10)).padStart(2, "0");
          var d3 = String(parseInt(m[3], 10)).padStart(2, "0");
          return y3 + "-" + m3 + "-" + d3;
        }
      }
      return null;
    }

    function buildOrganicCode(workbook) {
      var sheet = workbook.Sheets["zrl_country_monthly"] || workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        return "// 未找到 sheet：zrl_country_monthly（或第一个 sheet 为空）";
      }

      var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
      if (!rows || !rows.length) {
        return "// 表内没有数据";
      }

      var header = rows[0] || [];
      function idx(name) { return header.indexOf(name); }

      var idxDate = idx("date");
      var idxCountry = idx("country");
      if (idxDate < 0 || idxCountry < 0) {
        return "// 表头缺少必需字段：date / country";
      }

      var colMap = {
        registration: idx("注册人数"),
        D0_unique_purchase: idx("D0充值人数"),
        D7_unique_purchase: idx("D7充值人数"),
        D0_PURCHASE_VALUE: idx("D0充值金额"),
        D7_PURCHASE_VALUE: idx("D7充值金额"),
        D0_TOTAL_BET_PLACED_USER: idx("D0下注人数"),
        D7_TOTAL_BET_PLACED_USER: idx("D7下注人数"),
        D0_SPORTS_BET_PLACED_USER: idx("D0体育下注人数"),
        D0_GAMES_BET_PLACED_USER: idx("D0游戏下注人数"),
        D7_SPORTS_BET_PLACED_USER: idx("D7体育下注人数"),
        D7_GAMES_BET_PLACED_USER: idx("D7游戏下注人数"),
        D0_SPORTS_BET_FLOW: idx("D0体育流水"),
        D0_GAMES_BET_FLOW: idx("D0游戏流水"),
        D0_TOTAL_BET_FLOW: idx("D0总流水"),
        D7_SPORTS_BET_FLOW: idx("D7体育流水"),
        D7_GAMES_BET_FLOW: idx("D7游戏流水"),
        D7_TOTAL_BET_FLOW: idx("D7总流水"),
        D1_retained_users: idx("次日登录人数"),
        D7_retained_users: idx("七日登录人数")
      };

      var monthMap = {};

      for (var i = 1; i < rows.length; i++) {
        var r = rows[i];
        if (!r || !r.length) continue;

        var rawDate = r[idxDate];
        var dateStr = normalizeDateCell(rawDate);
        if (!dateStr) continue;

        var monthKey = dateStr.slice(0, 7);
        var rawCountry = r[idxCountry];
        if (!rawCountry) continue;
        var country = String(rawCountry).trim().toUpperCase();

        // 跳过第二行英文字段说明（通常 date / country 等字符串会进到这一行）
        if (i === 1 && dateStr === "date" && country === "COUNTRY") continue;

        var lines = [];
        lines.push("  {");
        lines.push('    date: "' + dateStr + '",');
        lines.push('    country: "' + country + '",');

        Object.keys(colMap).forEach(function (key) {
          var colIdx = colMap[key];
          if (colIdx < 0) return;
          var v = r[colIdx];
          var jsNum = formatJsNumber(v);
          lines.push("    " + key + ": " + jsNum + ",");
        });

        lines.push("  }");

        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(lines.join("\n"));
      }

      var monthKeys = Object.keys(monthMap).sort();
      if (!monthKeys.length) {
        return "// 没读到任何有效自然量数据行";
      }

      var out = [];
      monthKeys.forEach(function (mk, idx) {
        out.push("// ===== " + mk + " 自然量（粘贴到 RAW_ORGANIC_BY_MONTH 对象里） =====");
        out.push('"' + mk + '": [');
        out.push(monthMap[mk].join(",\n"));
        out.push("]");
        if (idx < monthKeys.length - 1) {
          out.push("");
          out.push("");
        }
      });

      return out.join("\n");
    }

    function buildPaidCode(workbook) {
      var sheet = workbook.Sheets["Sheet1"] || workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        return "// 未找到 sheet：Sheet1（或第一个 sheet 为空）";
      }

      var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
      if (!rows || !rows.length) {
        return "// 表内没有数据";
      }

      var header = rows[0] || [];
      function idx(name) { return header.indexOf(name); }

      var idxDate = idx("date");
      var idxCountry = idx("country");
      var idxMedia = idx("media");
      var idxProductType = idx("Product_type");
      if (idxDate < 0 || idxCountry < 0 || idxMedia < 0 || idxProductType < 0) {
        return "// 表头缺少必需字段：date / country / media / Product_type";
      }

      var colMap = {
        spent: idx("spent"),
        registration: idx("registration"),
        D0_unique_purchase: idx("D0_unique_purchase"),
        D7_unique_purchase: idx("D7_unique_purchase"),
        D0_PURCHASE_VALUE: idx("D0_PURCHASE_VALUE"),
        D7_PURCHASE_VALUE: idx("D7_PURCHASE_VALUE"),
        D0_TOTAL_BET_PLACED_USER: idx("D0_TOTAL_BET_PLACED_USER"),
        D7_TOTAL_BET_PLACED_USER: idx("D7_TOTAL_BET_PLACED_USER"),
        D0_SPORTS_BET_PLACED_USER: idx("D0_SPORTS_BET_PLACED_USER"),
        D0_GAMES_BET_PLACED_USER: idx("D0_GAMES_BET_PLACED_USER"),
        D7_SPORTS_BET_PLACED_USER: idx("D7_SPORTS_BET_PLACED_PLACED_USER") >= 0
          ? idx("D7_SPORTS_BET_PLACED_PLACED_USER")
          : idx("D7_SPORTS_BET_PLACED_USER"),
        D7_GAMES_BET_PLACED_USER: idx("D7_GAMES_BET_PLACED_USER"),
        D0_SPORTS_BET_FLOW: idx("D0_SPORTS_BET_FLOW"),
        D0_GAMES_BET_FLOW: idx("D0_GAMES_BET_FLOW"),
        D0_TOTAL_BET_FLOW: idx("D0_TOTAL_BET_FLOW"),
        D7_SPORTS_BET_FLOW: idx("D7_SPORTS_BET_FLOW"),
        D7_GAMES_BET_FLOW: idx("D7_GAMES_BET_FLOW"),
        D7_TOTAL_BET_FLOW: idx("D7_TOTAL_BET_FLOW"),
        D1_retained_users: idx("D1_retained_users"),
        D7_retained_users: idx("D7_retained_users"),
        total_ggr: idx("D7_GGR_VALUE"),
        sports_ggr: idx("D7_SPORTS_GGR_VALUE"),
        games_ggr: idx("D7_GAMES_GGR_VALUE")
      };

      var monthMap = {};

      for (var i = 1; i < rows.length; i++) {
        var r = rows[i];
        if (!r || !r.length) continue;

        var rawDate = r[idxDate];
        var dateStr = normalizeDateCell(rawDate);
        if (!dateStr) continue;

        var monthKey = dateStr.slice(0, 7);
        var rawCountry = r[idxCountry];
        if (!rawCountry) continue;
        var country = String(rawCountry).trim().toUpperCase();

        var media = r[idxMedia] != null ? String(r[idxMedia]).trim() : "";
        var productType = r[idxProductType] != null ? String(r[idxProductType]).trim() : "";

        var lines = [];
        lines.push("  {");
        lines.push('    date: "' + dateStr + '",');
        lines.push('    country: "' + country + '",');
        lines.push('    media: "' + media + '",');
        lines.push('    productType: "' + productType + '",');

        Object.keys(colMap).forEach(function (key) {
          var colIdx = colMap[key];
          if (colIdx < 0) return;
          var v = r[colIdx];
          var jsNum = formatJsNumber(v);
          lines.push("    " + key + ": " + jsNum + ",");
        });

        lines.push("  }");

        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(lines.join("\n"));
      }

      var monthKeys = Object.keys(monthMap).sort();
      if (!monthKeys.length) {
        return "// 没读到任何有效买量数据行";
      }

      var out = [];
      monthKeys.forEach(function (mk, idx) {
        out.push("// ===== " + mk + " 买量（粘贴到 RAW_PAID_BY_MONTH 对象里） =====");
        out.push('"' + mk + '": [');
        out.push(monthMap[mk].join(",\n"));
        out.push("]");
        if (idx < monthKeys.length - 1) {
          out.push("");
          out.push("");
        }
      });

      return out.join("\n");
    }

    function readWorkbookFromFile(file, onDone) {
      var reader = new FileReader();
      reader.onload = function (evt) {
        try {
          var data = evt.target.result;
          var wb = XLSX.read(data, { type: "array" });
          onDone(null, wb);
        } catch (err) {
          onDone(err || new Error("解析 Excel 出错"));
        }
      };
      reader.onerror = function (err) {
        onDone(err || new Error("读取文件失败"));
      };
      reader.readAsArrayBuffer(file);
    }

    function bindCopyButton(btnId, textareaId) {
      var btn = document.getElementById(btnId);
      var ta = document.getElementById(textareaId);
      if (!btn || !ta) return;

      btn.addEventListener("click", function () {
        if (!ta.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(ta.value).catch(function () {});
        } else {
          ta.select();
          document.execCommand("copy");
        }
      });
    }

    function bindGenerateButtons() {
      var orgBtn = document.getElementById("gen-org");
      var orgInput = document.getElementById("organic-file");
      var orgOut = document.getElementById("organic-output");

      if (orgBtn && orgInput && orgOut) {
        orgBtn.addEventListener("click", function () {
          orgOut.value = "";
          if (!orgInput.files || !orgInput.files[0]) {
            orgOut.value = "// 请先选择自然量 Excel 文件";
            return;
          }
          readWorkbookFromFile(orgInput.files[0], function (err, wb) {
            if (err) {
              orgOut.value = "// 解析自然量 Excel 出错：\\n// " + (err.message || String(err));
              return;
            }
            orgOut.value = buildOrganicCode(wb);
          });
        });
      }

      var paidBtn = document.getElementById("gen-paid");
      var paidInput = document.getElementById("paid-file");
      var paidOut = document.getElementById("paid-output");

      if (paidBtn && paidInput && paidOut) {
        paidBtn.addEventListener("click", function () {
          paidOut.value = "";
          if (!paidInput.files || !paidInput.files[0]) {
            paidOut.value = "// 请先选择买量 Excel 文件";
            return;
          }
          readWorkbookFromFile(paidInput.files[0], function (err, wb) {
            if (err) {
              paidOut.value = "// 解析买量 Excel 出错：\\n// " + (err.message || String(err));
              return;
            }
            paidOut.value = buildPaidCode(wb);
          });
        });
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      bindGenerateButtons();
      bindCopyButton("copy-org", "organic-output");
      bindCopyButton("copy-paid", "paid-output");
    });
  </script>
</body>
</html>
