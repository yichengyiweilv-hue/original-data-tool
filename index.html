<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>自然量 & 买量 Excel → JS 源数据转换小工具</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --border: #334155;
      --border-soft: #1f2937;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.12);
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC",
        "Microsoft Yahei",sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page { max-width: 1200px; margin: 0 auto; }

    .header {
      margin-bottom: 16px;
      padding: 16px 18px 12px;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.45);
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(12,148,136,0.18), transparent 55%),
        rgba(15,23,42,0.98);
      box-shadow: 0 20px 45px rgba(15,23,42,0.9);
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #f9fafb;
    }

    .header-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 8px;
    }

    .header-note {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .badge-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text-sub);
    }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    @media (max-width: 960px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), #020617);
      box-shadow: 0 16px 36px rgba(15,23,42,0.9);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 280px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border-soft);
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .file-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-sub);
    }

    .file-input {
      font-size: 11px;
      color: var(--text-main);
    }

    .btn-copy {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      cursor: pointer;
    }

    .btn-copy:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: #e0f2fe;
    }

    .output {
      flex: 1;
      min-height: 200px;
      margin-top: 4px;
    }

    textarea {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #020617;
      color: var(--text-main);
      font-size: 11px;
      padding: 8px;
      resize: vertical;
      font-family: Menlo, Consolas, "SF Mono", monospace;
      line-height: 1.5;
      outline: none;
    }

    textarea::placeholder { color: var(--text-sub); }

    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
      border-top: 1px dashed var(--border-soft);
      padding-top: 6px;
    }

    .hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.5;
    }

    .hint strong { color: #e5e7eb; }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="header-title">自然量 & 买量 Excel → JS 源数据转换小工具</div>
      <div class="header-sub">
        本地打开本页面，上传自然量 / 买量 Excel，自动生成可以直接粘贴的 <code>"YYYY-MM": [ {{...}} ]</code> 源数据片段。
      </div>
      <div class="header-note">
        · 自然量：sheet 名 <strong>zrl_country_monthly</strong>，第 1 行为表头（date / country / 注册人数等），第 2 行为英文字段说明（registration / D0_unique_purchase...）<br />
        · 买量：sheet 名 <strong>Sheet1</strong>，第 1 行为英文字段（date / country / media / Product_type / spent ...）<br />
        · 输出片段可直接粘贴到你现有的 <code>RAW_ORGANIC_BY_MONTH</code> / <code>RAW_PAID_BY_MONTH</code> 对象里，无需额外包装。
      </div>
      <div class="badge-row">
        <span class="badge">纯前端 · 无需安装软件</span>
        <span class="badge">字段口径对齐你现有看板</span>
      </div>
    </header>

    <main class="main-grid">
      <!-- 自然量 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">自然量 Excel → JS 片段</div>
            <div class="card-sub">
              输出格式示例：<code>"2025-10": [ {"date": "...", "country": "GH", ... } ]</code>
            </div>
          </div>
          <button type="button" class="btn-copy" id="copy-org">复制自然量 code</button>
        </div>
        <div class="file-row">
          <span>自然量 Excel：</span>
          <input type="file" id="organic-file" class="file-input" accept=".xlsx,.xls" />
        </div>
        <div class="hint">
          · 要求：表头包含 <strong>date</strong> / <strong>country</strong> / <strong>注册人数</strong> / <strong>D0充值人数</strong> 等；第 2 行为英文字段说明会被自动跳过。<br />
          · 如一个文件里有多个月，会自动按日期拆成多个 <code>"YYYY-MM": [ ... ]</code> 片段。
        </div>
        <div class="output">
          <textarea id="organic-output" placeholder='上传自然量 Excel 后，这里会生成类似：

// ===== 2025-10 自然量（粘贴到 RAW_ORGANIC_BY_MONTH 对象里） =====
"2025-10": [
  {
    date: "2025-10-01",
    country: "GH",
    registration: 100,
    D0_unique_purchase: 20,
    D7_unique_purchase: 28,
    ...
  }
  // ... 其他日期 × 国家
]
'></textarea>
        </div>
      </section>

      <!-- 买量 -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">买量 Excel → JS 片段</div>
            <div class="card-sub">
              输出格式示例：<code>"2025-10": [ {"date": "...", "media": "FB", "productType": "app", ... } ]</code>
            </div>
          </div>
          <button type="button" class="btn-copy" id="copy-paid">复制买量 code</button>
        </div>
        <div class="file-row">
          <span>买量 Excel：</span>
          <input type="file" id="paid-file" class="file-input" accept=".xlsx,.xls" />
        </div>
        <div class="hint">
          · 要求：表头包含 <strong>date</strong> / <strong>country</strong> / <strong>media</strong> / <strong>Product_type</strong> / <strong>spent</strong> 等。<br />
          · 输出字段包括：<code>date</code>、<code>country</code>、<code>media</code>、<code>productType</code>、<code>spent</code>、D0/D7 指标以及 <code>total_ggr</code> / <code>sports_ggr</code> / <code>games_ggr</code>。
        </div>
        <div class="output">
          <textarea id="paid-output" placeholder='上传买量 Excel 后，这里会生成类似：

// ===== 2025-10 买量（粘贴到 RAW_PAID_BY_MONTH 对象里） =====
"2025-10": [
  {
    date: "2025-10-01",
    country: "GH",
    media: "FB",
    productType: "app",
    spent: 500.0,
    registration: 200,
    D0_unique_purchase: 45,
    D7_unique_purchase: 70,
    ...
    total_ggr: 0,
    sports_ggr: 0,
    games_ggr: 0
  }
  // ... 其他日期 × 国家 × 媒体 / 产品
]
'></textarea>
        </div>
      </section>
    </main>

    <footer class="footer">
      建议：每月数据导出后，用本页面一键转 JS，直接把对应月份代码片段粘进你的看板数据源区域。
    </footer>
  </div>

  <!-- 解析 Excel 的免费库：xlsx.js（CDN 引入，无需安装） -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    function formatJsNumber(value) {
      if (value === null || value === undefined || value === "") return "0";
      var num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (Math.abs(num - Math.round(num)) < 1e-9) {
        return String(Math.round(num));
      }
      return num.toFixed(2).replace(/\\.00$/, "");
    }

    function normalizeDateCell(v) {
      if (v === null || v === undefined || v === "") return null;

      if (v instanceof Date) {
        var y = v.getFullYear();
        var m = String(v.getMonth() + 1).padStart(2, "0");
        var d = String(v.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + d;
      }

      if (typeof v === "number") {
        if (typeof XLSX !== "undefined" && XLSX.SSF && XLSX.SSF.parse_date_code) {
          var o = XLSX.SSF.parse_date_code(v);
          if (o && o.y && o.m && o.d) {
            var y2 = o.y;
            var m2 = String(o.m).padStart(2, "0");
            var d2 = String(o.d).padStart(2, "0");
            return y2 + "-" + m2 + "-" + d2;
          }
        }
      }

      if (typeof v === "string") {
        var m = v.match(/(\\d{4})[-/](\\d{1,2})[-/](\\d{1,2})/);
        if (m) {
          var y3 = m[1];
          var m3 = String(parseInt(m[2], 10)).padStart(2, "0");
          var d3 = String(parseInt(m[3], 10)).padStart(2, "0");
          return y3 + "-" + m3 + "-" + d3;
        }
      }
      return null;
    }

    function buildOrganicCode(workbook) {
      var sheet = workbook.Sheets["zrl_country_monthly"] || workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        return "// 未找到 sheet：zrl_country_monthly（或第一个 sheet 为空）";
      }

      var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
      if (!rows || !rows.length) {
        return "// 表内没有数据";
      }

      var header = rows[0] || [];
      function idx(name) { return header.indexOf(name); }

      var idxDate = idx("date");
      var idxCountry = idx("country");
      if (idxDate < 0 || idxCountry < 0) {
        return "// 表头缺少必需字段：date / country";
      }

      var colMap = {
        registration: idx("注册人数"),
        D0_unique_purchase: idx("D0充值人数"),
        D7_unique_purchase: idx("D7充值人数"),
        D0_PURCHASE_VALUE: idx("D0充值金额"),
        D7_PURCHASE_VALUE: idx("D7充值金额"),
        D0_TOTAL_BET_PLACED_USER: idx("D0下注人数"),
        D7_TOTAL_BET_PLACED_USER: idx("D7下注人数"),
        D0_SPORTS_BET_PLACED_USER: idx("D0体育下注人数"),
        D0_GAMES_BET_PLACED_USER: idx("D0游戏下注人数"),
        D7_SPORTS_BET_PLACED_USER: idx("D7体育下注人数"),
        D7_GAMES_BET_PLACED_USER: idx("D7游戏下注人数"),
        D0_SPORTS_BET_FLOW: idx("D0体育流水"),
        D0_GAMES_BET_FLOW: idx("D0游戏流水"),
        D0_TOTAL_BET_FLOW: idx("D0总流水"),
        D7_SPORTS_BET_FLOW: idx("D7体育流水"),
        D7_GAMES_BET_FLOW: idx("D7游戏流水"),
        D7_TOTAL_BET_FLOW: idx("D7总流水"),
        D1_retained_users: idx("次日登录人数"),
        D7_retained_users: idx("七日登录人数")
      };

      var monthMap = {};

      for (var i = 1; i < rows.length; i++) {
        var r = rows[i];
        if (!r || !r.length) continue;

        var rawDate = r[idxDate];
        var dateStr = normalizeDateCell(rawDate);
        if (!dateStr) continue;

        var monthKey = dateStr.slice(0, 7);
        var rawCountry = r[idxCountry];
        if (!rawCountry) continue;
        var country = String(rawCountry).trim().toUpperCase();

        var lines = [];
        lines.push("  {");
        lines.push('    date: "' + dateStr + '",');
        lines.push('    country: "' + country + '",');

        Object.keys(colMap).forEach(function (key) {
          var colIdx = colMap[key];
          if (colIdx < 0) return;
          var v = r[colIdx];
          var jsNum = formatJsNumber(v);
          lines.push("    " + key + ": " + jsNum + ",");
        });

        lines.push("  }");

        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(lines.join("\\n"));
      }

      var monthKeys = Object.keys(monthMap).sort();
      if (!monthKeys.length) {
        return "// 没读到任何有效自然量数据行";
      }

      var out = [];
      monthKeys.forEach(function (mk, idx) {
        out.push("// ===== " + mk + " 自然量（粘贴到 RAW_ORGANIC_BY_MONTH 对象里） =====");
        out.push('"' + mk + '": [');
        out.push(monthMap[mk].join(",\\n"));
        out.push("]");
        if (idx < monthKeys.length - 1) {
          out.push("");
          out.push("");
        }
      });

      return out.join("\\n");
    }

    function buildPaidCode(workbook) {
      var sheet = workbook.Sheets["Sheet1"] || workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        return "// 未找到 sheet：Sheet1（或第一个 sheet 为空）";
      }

      var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
      if (!rows || !rows.length) {
        return "// 表内没有数据";
      }

      var header = rows[0] || [];
      function idx(name) { return header.indexOf(name); }

      var idxDate = idx("date");
      var idxCountry = idx("country");
      var idxMedia = idx("media");
      var idxProductType = idx("Product_type");
      if (idxDate < 0 || idxCountry < 0 || idxMedia < 0 || idxProductType < 0) {
        return "// 表头缺少必需字段：date / country / media / Product_type";
      }

      var colMap = {
        spent: idx("spent"),
        registration: idx("registration"),
        D0_unique_purchase: idx("D0_unique_purchase"),
        D7_unique_purchase: idx("D7_unique_purchase"),
        D0_PURCHASE_VALUE: idx("D0_PURCHASE_VALUE"),
        D7_PURCHASE_VALUE: idx("D7_PURCHASE_VALUE"),
        D0_TOTAL_BET_PLACED_USER: idx("D0_TOTAL_BET_PLACED_USER"),
        D7_TOTAL_BET_PLACED_USER: idx("D7_TOTAL_BET_PLACED_USER"),
        D0_SPORTS_BET_PLACED_USER: idx("D0_SPORTS_BET_PLACED_USER"),
        D0_GAMES_BET_PLACED_USER: idx("D0_GAMES_BET_PLACED_USER"),
        D7_SPORTS_BET_PLACED_USER: idx("D7_SPORTS_BET_PLACED_USER"),
        D7_GAMES_BET_PLACED_USER: idx("D7_GAMES_BET_PLACED_USER"),
        D0_SPORTS_BET_FLOW: idx("D0_SPORTS_BET_FLOW"),
        D0_GAMES_BET_FLOW: idx("D0_GAMES_BET_FLOW"),
        D0_TOTAL_BET_FLOW: idx("D0_TOTAL_BET_FLOW"),
        D7_SPORTS_BET_FLOW: idx("D7_SPORTS_BET_FLOW"),
        D7_GAMES_BET_FLOW: idx("D7_GAMES_BET_FLOW"),
        D7_TOTAL_BET_FLOW: idx("D7_TOTAL_BET_FLOW"),
        D1_retained_users: idx("D1_retained_users"),
        D7_retained_users: idx("D7_retained_users"),
        total_ggr: idx("D7_GGR_VALUE"),
        sports_ggr: idx("D7_SPORTS_GGR_VALUE"),
        games_ggr: idx("D7_GAMES_GGR_VALUE")
      };

      var monthMap = {};

      for (var i = 1; i < rows.length; i++) {
        var r = rows[i];
        if (!r || !r.length) continue;

        var rawDate = r[idxDate];
        var dateStr = normalizeDateCell(rawDate);
        if (!dateStr) continue;

        var monthKey = dateStr.slice(0, 7);
        var rawCountry = r[idxCountry];
        if (!rawCountry) continue;
        var country = String(rawCountry).trim().toUpperCase();

        var media = r[idxMedia] != null ? String(r[idxMedia]).trim() : "";
        var productType = r[idxProductType] != null ? String(r[idxProductType]).trim() : "";

        var lines = [];
        lines.push("  {");
        lines.push('    date: "' + dateStr + '",');
        lines.push('    country: "' + country + '",');
        lines.push('    media: "' + media + '",');
        lines.push('    productType: "' + productType + '",');

        Object.keys(colMap).forEach(function (key) {
          var colIdx = colMap[key];
          if (colIdx < 0) return;
          var v = r[colIdx];
          var jsNum = formatJsNumber(v);
          lines.push("    " + key + ": " + jsNum + ",");
        });

        lines.push("  }");

        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(lines.join("\\n"));
      }

      var monthKeys = Object.keys(monthMap).sort();
      if (!monthKeys.length) {
        return "// 没读到任何有效买量数据行";
      }

      var out = [];
      monthKeys.forEach(function (mk, idx) {
        out.push("// ===== " + mk + " 买量（粘贴到 RAW_PAID_BY_MONTH 对象里） =====");
        out.push('"' + mk + '": [');
        out.push(monthMap[mk].join(",\\n"));
        out.push("]");
        if (idx < monthKeys.length - 1) {
          out.push("");
          out.push("");
        }
      });

      return out.join("\\n");
    }

    function bindFileInput(inputId, type) {
      var input = document.getElementById(inputId);
      if (!input) return;

      input.addEventListener("change", function (e) {
        var file = e.target.files && e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function (evt) {
          try {
            var data = evt.target.result;
            var wb = XLSX.read(data, { type: "array" });
            if (type === "organic") {
              document.getElementById("organic-output").value = buildOrganicCode(wb);
            } else {
              document.getElementById("paid-output").value = buildPaidCode(wb);
            }
          } catch (err) {
            var msg = "// 解析 Excel 时出错：\\n// " + (err && err.message ? err.message : String(err));
            if (type === "organic") {
              document.getElementById("organic-output").value = msg;
            } else {
              document.getElementById("paid-output").value = msg;
            }
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function bindCopyButton(btnId, textareaId) {
      var btn = document.getElementById(btnId);
      var ta = document.getElementById(textareaId);
      if (!btn || !ta) return;

      btn.addEventListener("click", function () {
        if (!ta.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(ta.value).catch(function () {});
        } else {
          ta.select();
          document.execCommand("copy");
        }
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      bindFileInput("organic-file", "organic");
      bindFileInput("paid-file", "paid");
      bindCopyButton("copy-org", "organic-output");
      bindCopyButton("copy-paid", "paid-output");
    });
  </script>
</body>
</html>
