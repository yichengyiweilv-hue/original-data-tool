<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>月自然量数据源 → JS 代码生成工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --border: #e5e7eb;
      --border-soft: #d1d5db;
      --text-main: #111827;
      --text-sub: #6b7280;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 20px;
      font-weight: 650;
    }

    p {
      margin: 0 0 6px;
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    code {
      font-family: SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #f3f4f6;
      padding: 1px 4px;
      border-radius: 4px;
    }

    .card {
      margin-top: 14px;
      padding: 14px 16px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 10px 0 8px;
    }

    .field {
      flex: 1 1 260px;
      min-width: 0;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
    }

    .input-box {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      font-size: 13px;
      background: #ffffff;
    }

    .input-box:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    input[type="file"] {
      padding: 3px 0;
      border: none;
      box-shadow: none;
    }

    .small-tip {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 4px 0 8px;
    }

    button {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #f3f4f6;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-main);
      transition: all 0.15s ease-out;
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
    }

    button.primary:hover {
      background: #1d4ed8;
      border-color: #1d4ed8;
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.25);
      transform: translateY(-0.5px);
    }

    button:hover:not(:disabled):not(.primary) {
      background: #e5e7eb;
      border-color: #cbd5f5;
      transform: translateY(-0.5px);
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.35);
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    #status {
      font-size: 12px;
      color: var(--text-sub);
      margin: 2px 0 6px;
    }

    textarea {
      width: 100%;
      min-height: 260px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 8px 9px;
      font-family: SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.45;
      resize: vertical;
      background: #0f172a;
      color: #e5e7eb;
      outline: none;
    }

    textarea::placeholder {
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>月自然量数据源 → JS 代码生成工具</h1>
    <p>
      上传当月自然量 Excel（按国家 × 日期），自动生成
      <code>"YYYY-MM": [ &#123; ... &#125; ]</code> 片段，直接粘贴进看板的
      数据源对象。
    </p>
    <p class="small-tip">
      默认读取 sheet 名为 <code>zrl_country_monthly</code>，如果不存在则使用第 1 个
      sheet。第 1 行为表头（含 <code>date</code> / <code>country</code> /
      <code>注册人数</code> 等），第 2 行若为英文字段说明会被自动跳过。
    </p>

    <section class="card">
      <div class="row">
        <div class="field">
          <label for="fileInput">自然量 Excel 文件</label>
          <input
            id="fileInput"
            class="input-box"
            type="file"
            accept=".xlsx,.xls"
          />
          <div class="small-tip">
            示例：2025-10 整月数据，表头至少包含
            <code>date</code>、<code>country</code>、
            <code>注册人数</code>、<code>D0充值人数</code> 等字段。
          </div>
        </div>
      </div>

      <div class="btn-row">
        <button id="generateBtn" class="primary" type="button">
          生成 code
        </button>
        <button id="copyBtn" type="button" disabled>一键复制</button>
      </div>

      <div id="status">状态：等待上传自然量 Excel 文件。</div>

      <textarea
        id="output"
        readonly
        spellcheck="false"
        placeholder='// 上传自然量 Excel 后，点击「生成 code」，这里会生成类似：
//
// "2025-09": [
//   {
//     date: "2025-09-01", // YYYY-MM-DD
//     country: "GH",      // GH / KE / NG / TZ / UG
//
//     // 注册 & 付费（D0）
//     registration: 302,
//     D0_unique_purchase: 138,
//     D0_PURCHASE_VALUE: 561.46,
//
//     // 投注人数（D0）
//     D0_TOTAL_BET_PLACED_USER: 139,
//     D0_SPORTS_BET_PLACED_USER: 64,
//     D0_GAMES_BET_PLACED_USER: 104,
//
//     // 流水（D0）
//     D0_SPORTS_BET_FLOW: 93.48,
//     D0_GAMES_BET_FLOW: 2211.0,
//     D0_TOTAL_BET_FLOW: 2304.49,
//
//     // 付费 & 投注（D7）
//     D7_unique_purchase: 172,
//     D7_PURCHASE_VALUE: 3002.0,
//     D7_TOTAL_BET_PLACED_USER: 177,
//     D7_SPORTS_BET_PLACED_USER: 108,
//     D7_GAMES_BET_PLACED_USER: 138,
//
//     // 流水（D7）
//     D7_SPORTS_BET_FLOW: 532.02,
//     D7_GAMES_BET_FLOW: 16393.33,
//     D7_TOTAL_BET_FLOW: 16925.36,
//
//     // 留存
//     D1_retained_users: 139,
//     D7_retained_users: 61,
//   },
//   // ... 其他日期 × 国家
// ],'
      ></textarea>
    </section>
  </div>

  <!-- 使用和你现有工具相同版本的 XLSX 库 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // 数字格式，与现有工具保持一致
    function formatJsNumber(value) {
      if (value === null || value === undefined || value === "") return "0";
      var num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (Math.abs(num - Math.round(num)) < 1e-9) {
        return String(Math.round(num));
      }
      return num.toFixed(2).replace(/\.00$/, "");
    }

    // 和「买量&自然量」工具同源的日期处理，避免时区减一天
    function normalizeDateCell(v) {
      if (v === null || v === undefined || v === "") return null;

      // 1）Date 对象：用本地年月日
      if (v instanceof Date) {
        var y = v.getFullYear();
        var m = String(v.getMonth() + 1).padStart(2, "0");
        var d = String(v.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + d;
      }

      // 2）Excel 数字日期（序列号）
      if (typeof v === "number") {
        if (typeof XLSX !== "undefined" && XLSX.SSF && XLSX.SSF.parse_date_code) {
          var o = XLSX.SSF.parse_date_code(v);
          if (o && o.y && o.m && o.d) {
            var y2 = o.y;
            var m2 = String(o.m).padStart(2, "0");
            var d2 = String(o.d).padStart(2, "0");
            return y2 + "-" + m2 + "-" + d2;
          }
        }
      }

      // 3）字符串日期：2025-10-01 / 2025/10/1 等
      if (typeof v === "string") {
        var m = v.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
        if (m) {
          var y3 = m[1];
          var m3 = String(parseInt(m[2], 10)).padStart(2, "0");
          var d3 = String(parseInt(m[3], 10)).padStart(2, "0");
          return y3 + "-" + m3 + "-" + d3;
        }
      }

      return null;
    }

    // 从工作簿构造月自然量代码（按照你给的示例结构）
    function buildOrganicCode(workbook) {
      var sheet =
        workbook.Sheets["zrl_country_monthly"] ||
        workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        return "// 未找到 sheet：zrl_country_monthly（或第一个 sheet 为空）";
      }

      // 和旧工具一致：header: 1 → 第一行当表头，后续行是数组
      var rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
      if (!rows || !rows.length) {
        return "// 表内没有数据";
      }

      var header = rows[0] || [];
      function idx(name) {
        return header.indexOf(name);
      }

      var idxDate = idx("date");
      var idxCountry = idx("country");

      if (idxDate < 0 || idxCountry < 0) {
        return "// 表头缺少必需字段：date / country";
      }

      // 中文表头 → 看板字段名映射
      var colMap = {
        registration: idx("注册人数"),
        D0_unique_purchase: idx("D0充值人数"),
        D7_unique_purchase: idx("D7充值人数"),
        D0_PURCHASE_VALUE: idx("D0充值金额"),
        D7_PURCHASE_VALUE: idx("D7充值金额"),
        D0_TOTAL_BET_PLACED_USER: idx("D0下注人数"),
        D7_TOTAL_BET_PLACED_USER: idx("D7下注人数"),
        D0_SPORTS_BET_PLACED_USER: idx("D0体育下注人数"),
        D0_GAMES_BET_PLACED_USER: idx("D0游戏下注人数"),
        D7_SPORTS_BET_PLACED_USER: idx("D7体育下注人数"),
        D7_GAMES_BET_PLACED_USER: idx("D7游戏下注人数"),
        D0_SPORTS_BET_FLOW: idx("D0体育流水"),
        D0_GAMES_BET_FLOW: idx("D0游戏流水"),
        D0_TOTAL_BET_FLOW: idx("D0总流水"),
        D7_SPORTS_BET_FLOW: idx("D7体育流水"),
        D7_GAMES_BET_FLOW: idx("D7游戏流水"),
        D7_TOTAL_BET_FLOW: idx("D7总流水"),
        D1_retained_users: idx("次日登录人数"),
        D7_retained_users: idx("七日登录人数"),
      };

      // monthKey → 若干天数据的代码片段
      var monthMap = {};

      for (var i = 1; i < rows.length; i++) {
        var r = rows[i];
        if (!r || !r.length) continue;

        var rawDate = r[idxDate];
        var dateStr = normalizeDateCell(rawDate);
        if (!dateStr) continue;

        var rawCountry = r[idxCountry];
        if (!rawCountry) continue;
        var country = String(rawCountry).trim().toUpperCase();

        var monthKey = dateStr.slice(0, 7);

        // 单行取数函数
        function numVal(fieldKey) {
          var colIdx = colMap[fieldKey];
          if (colIdx === undefined || colIdx === null || colIdx < 0) {
            return "0";
          }
          var v = r[colIdx];
          return formatJsNumber(v);
        }

        var indent1 = "  ";
        var indent2 = "    ";
        var lines = [];

        lines.push(indent1 + "{");
        lines.push(indent2 + 'date: "' + dateStr + '", // YYYY-MM-DD');
        lines.push(
          indent2 + 'country: "' + country + '", // GH / KE / NG / TZ / UG'
        );
        lines.push("");

        // 注册 & 付费（D0）
        lines.push(indent2 + "// 注册 & 付费（D0）");
        lines.push(indent2 + "registration: " + numVal("registration") + ",");
        lines.push(
          indent2 +
            "D0_unique_purchase: " +
            numVal("D0_unique_purchase") +
            ",",
        );
        lines.push(
          indent2 + "D0_PURCHASE_VALUE: " + numVal("D0_PURCHASE_VALUE") + ",",
        );
        lines.push("");

        // 投注人数（D0）
        lines.push(indent2 + "// 投注人数（D0）");
        lines.push(
          indent2 +
            "D0_TOTAL_BET_PLACED_USER: " +
            numVal("D0_TOTAL_BET_PLACED_USER") +
            ",",
        );
        lines.push(
          indent2 +
            "D0_SPORTS_BET_PLACED_USER: " +
            numVal("D0_SPORTS_BET_PLACED_USER") +
            ",",
        );
        lines.push(
          indent2 +
            "D0_GAMES_BET_PLACED_USER: " +
            numVal("D0_GAMES_BET_PLACED_USER") +
            ",",
        );
        lines.push("");

        // 流水（D0）
        lines.push(indent2 + "// 流水（D0）");
        lines.push(
          indent2 +
            "D0_SPORTS_BET_FLOW: " +
            numVal("D0_SPORTS_BET_FLOW") +
            ",",
        );
        lines.push(
          indent2 +
            "D0_GAMES_BET_FLOW: " +
            numVal("D0_GAMES_BET_FLOW") +
            ",",
        );
        lines.push(
          indent2 +
            "D0_TOTAL_BET_FLOW: " +
            numVal("D0_TOTAL_BET_FLOW") +
            ",",
        );
        lines.push("");

        // 付费 & 投注（D7）
        lines.push(indent2 + "// 付费 & 投注（D7）");
        lines.push(
          indent2 +
            "D7_unique_purchase: " +
            numVal("D7_unique_purchase") +
            ",",
        );
        lines.push(
          indent2 + "D7_PURCHASE_VALUE: " + numVal("D7_PURCHASE_VALUE") + ",",
        );
        lines.push(
          indent2 +
            "D7_TOTAL_BET_PLACED_USER: " +
            numVal("D7_TOTAL_BET_PLACED_USER") +
            ",",
        );
        lines.push(
          indent2 +
            "D7_SPORTS_BET_PLACED_USER: " +
            numVal("D7_SPORTS_BET_PLACED_USER") +
            ",",
        );
        lines.push(
          indent2 +
            "D7_GAMES_BET_PLACED_USER: " +
            numVal("D7_GAMES_BET_PLACED_USER") +
            ",",
        );
        lines.push("");

        // 流水（D7）
        lines.push(indent2 + "// 流水（D7）");
        lines.push(
          indent2 +
            "D7_SPORTS_BET_FLOW: " +
            numVal("D7_SPORTS_BET_FLOW") +
            ",",
        );
        lines.push(
          indent2 +
            "D7_GAMES_BET_FLOW: " +
            numVal("D7_GAMES_BET_FLOW") +
            ",",
        );
        lines.push(
          indent2 +
            "D7_TOTAL_BET_FLOW: " +
            numVal("D7_TOTAL_BET_FLOW") +
            ",",
        );
        lines.push("");

        // 留存
        lines.push(indent2 + "// 留存");
        lines.push(
          indent2 +
            "D1_retained_users: " +
            numVal("D1_retained_users") +
            ",",
        );
        lines.push(
          indent2 +
            "D7_retained_users: " +
            numVal("D7_retained_users") +
            ",",
        );

        lines.push(indent1 + "},");

        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(lines.join("\n"));
      }

      var monthKeys = Object.keys(monthMap).sort();
      if (!monthKeys.length) {
        return "// 没读到任何有效自然量数据行";
      }

      var out = [];
      monthKeys.forEach(function (mk, idx) {
        out.push('"' + mk + '": [');
        out.push(monthMap[mk].join("\n\n"));
        out.push("],");
        if (idx < monthKeys.length - 1) {
          out.push("");
          out.push("");
        }
      });

      return out.join("\n");
    }

    // 通用：从文件读取工作簿（与旧工具一致）
    function readWorkbookFromFile(file, onDone) {
      var reader = new FileReader();
      reader.onload = function (evt) {
        try {
          var data = evt.target.result;
          var wb = XLSX.read(data, { type: "array" });
          onDone(null, wb);
        } catch (err) {
          onDone(err || new Error("解析 Excel 出错"));
        }
      };
      reader.onerror = function (err) {
        onDone(err || new Error("读取文件失败"));
      };
      reader.readAsArrayBuffer(file);
    }

    // 一键复制
    function bindCopyButton(btnId, textareaId, setStatus) {
      var btn = document.getElementById(btnId);
      var ta = document.getElementById(textareaId);
      if (!btn || !ta) return;

      btn.addEventListener("click", function () {
        if (!ta.value) {
          setStatus && setStatus("当前没有可复制内容。");
          return;
        }

        function fallbackCopy() {
          ta.focus();
          ta.select();
          try {
            document.execCommand("copy");
            setStatus &&
              setStatus("已复制到剪贴板，可以粘贴到看板源码中。");
          } catch (e) {
            setStatus && setStatus("浏览器不支持自动复制，请手动 Ctrl+C。");
          }
        }

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(ta.value)
            .then(function () {
              setStatus &&
                setStatus("已复制到剪贴板，可以粘贴到看板源码中。");
            })
            .catch(function () {
              fallbackCopy();
            });
        } else {
          fallbackCopy();
        }
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      var fileInput = document.getElementById("fileInput");
      var output = document.getElementById("output");
      var generateBtn = document.getElementById("generateBtn");
      var copyBtn = document.getElementById("copyBtn");
      var statusEl = document.getElementById("status");

      function setStatus(msg) {
        statusEl.textContent = "状态：" + msg;
      }

      bindCopyButton("copyBtn", "output", setStatus);

      generateBtn.addEventListener("click", function () {
        output.value = "";
        copyBtn.disabled = true;

        if (!fileInput.files || !fileInput.files[0]) {
          setStatus("请先选择自然量 Excel 文件。");
          output.value = "// 请先选择自然量 Excel 文件";
          return;
        }

        setStatus("解析 Excel 中...");
        readWorkbookFromFile(fileInput.files[0], function (err, wb) {
          if (err) {
            output.value =
              "// 解析自然量 Excel 出错：\n// " +
              (err.message || String(err));
            setStatus("解析自然量 Excel 出错，请检查文件格式。");
            copyBtn.disabled = true;
            return;
          }

          var code = buildOrganicCode(wb);
          output.value = code;
          if (code && !/^\/\/ /.test(code.trim())) {
            copyBtn.disabled = false;
            setStatus(
              "生成完成，如文件为单月数据，首行日期应是该月 1 号（如 2025-10-01）。"
            );
          } else {
            copyBtn.disabled = true;
            setStatus("生成完成，但未读到有效数据，请检查表头和日期列。");
          }
        });
      });
    });
  </script>
</body>
</html>
