<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>自然量数据代码生成工具</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    background-color: white;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 30px;
    color: #333;
  }
  h1 { font-size: 24px; margin-bottom: 20px; }
  .controls {
    margin-bottom: 20px;
    padding: 20px;
    background: #f9f9f9;
    border: 1px solid #eee;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  input[type="file"] {
    font-size: 16px;
  }
  button {
    padding: 10px 24px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background-color: #0056b3; }
  button:active { background-color: #004494; }
  
  /* 代码框样式 */
  #output-container {
    position: relative;
  }
  #output {
    width: 100%;
    height: 600px;
    font-family: "Menlo", "Monaco", "Consolas", "Courier New", monospace;
    font-size: 14px;
    background-color: white;
    border: 2px solid #ccc;
    border-radius: 4px;
    padding: 15px;
    box-sizing: border-box;
    white-space: pre;
    overflow: auto;
    resize: vertical;
    outline: none;
  }
  
  #msg {
    color: #28a745;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.5s;
  }
</style>
</head>
<body>

  <h1>自然量数据 Excel 转 Code 工具</h1>
  
  <div class="controls">
    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" />
    <button onclick="copyToClipboard()">一键复制代码</button>
    <span id="msg">已复制到剪贴板！</span>
  </div>

  <div id="output-container">
    <textarea id="output" placeholder="请上传 Excel 文件，代码将在这里生成..."></textarea>
  </div>

  <script>
    document.getElementById('fileInput').addEventListener('change', handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // raw: false 保证读取到的就是 Excel 里看到的字符串，避免时区自动转换问题
        const json = XLSX.utils.sheet_to_json(worksheet, {raw: false});
        
        try {
          processData(json);
        } catch (err) {
          alert("处理出错，请检查 Excel 表头是否与模板一致。\n错误信息: " + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function processData(data) {
      // 1. 按月份分组 (YYYY-MM)
      const grouped = {};
      
      data.forEach(row => {
        // 容错处理：获取日期字符串
        let dateStr = row['date'];
        if (!dateStr) return; 

        // 简单清洗日期格式，确保是 YYYY-MM-DD
        // 如果 Excel 里是 2025/11/1，尝试替换为 2025-11-01
        dateStr = dateStr.replace(/\//g, '-');
        
        // 提取月份 key
        const monthKey = dateStr.substring(0, 7); // "2025-11"
        if (!/^\d{4}-\d{2}$/.test(monthKey)) {
             // 如果日期格式很怪，跳过或记录
             return; 
        }

        if (!grouped[monthKey]) grouped[monthKey] = [];
        grouped[monthKey].push(row);
      });

      // 2. 生成代码字符串
      let output = "";
      const keys = Object.keys(grouped).sort(); // 按月份排序
      
      keys.forEach((mKey, index) => {
        output += `"${mKey}": [\n`;
        
        // 对当月数据按日期、国家排序（可选）
        grouped[mKey].sort((a, b) => (a.date > b.date ? 1 : -1));

        grouped[mKey].forEach(r => {
           // 辅助函数：安全获取数值
           const val = (k) => {
             const v = r[k];
             // 处理空值、undefined 为 0，保留原有数字
             return (v === undefined || v === null || v === '') ? 0 : v;
           };
           // 辅助函数：安全获取字符串
           const strVal = (k) => (r[k] || "").toString().trim();
           
           const country = strVal("country").toUpperCase();
           const date = strVal("date");
           
           output += `          {\n`;
           output += `            date: "${date}", // YYYY-MM-DD\n`;
           output += `            country: "${country}", // GH / KE / NG / TZ / UG\n\n`;
           
           output += `            // 注册 & 付费（D0）\n`;
           output += `            registration: ${val("registration")},\n`;
           output += `            D0_unique_purchase: ${val("D0_unique_purchase")},\n`;
           output += `            D0_PURCHASE_VALUE: ${val("D0_PURCHASE_VALUE")},\n\n`;

           output += `            // 投注人数（D0）\n`;
           output += `            D0_TOTAL_BET_PLACED_USER: ${val("D0_TOTAL_BET_PLACED_USER")},\n`;
           output += `            D0_SPORTS_BET_PLACED_USER: ${val("D0_SPORTS_BET_PLACED_USER")},\n`;
           output += `            D0_GAMES_BET_PLACED_USER: ${val("D0_GAMES_BET_PLACED_USER")},\n\n`;
           
           output += `            // 流水（D0）\n`;
           output += `            D0_SPORTS_BET_FLOW: ${val("D0_SPORTS_BET_FLOW")},\n`;
           output += `            D0_GAMES_BET_FLOW: ${val("D0_GAMES_BET_FLOW")},\n`;
           output += `            D0_TOTAL_BET_FLOW: ${val("D0_TOTAL_BET_FLOW")},\n\n`;
           
           output += `            // 付费 & 投注（D7）\n`;
           output += `            D7_unique_purchase: ${val("D7_unique_purchase")},\n`;
           output += `            D7_PURCHASE_VALUE: ${val("D7_PURCHASE_VALUE")},\n`;
           output += `            D7_TOTAL_BET_PLACED_USER: ${val("D7_TOTAL_BET_PLACED_USER")},\n`;
           output += `            D7_SPORTS_BET_PLACED_USER: ${val("D7_SPORTS_BET_PLACED_USER")},\n`;
           output += `            D7_GAMES_BET_PLACED_USER: ${val("D7_GAMES_BET_PLACED_USER")},\n\n`;
           
           output += `            // 流水（D7）\n`;
           output += `            D7_SPORTS_BET_FLOW: ${val("D7_SPORTS_BET_FLOW")},\n`;
           output += `            D7_GAMES_BET_FLOW: ${val("D7_GAMES_BET_FLOW")},\n`;
           output += `            D7_TOTAL_BET_FLOW: ${val("D7_TOTAL_BET_FLOW")},\n\n`;
           
           output += `            // 留存\n`;
           output += `            D1_retained_users: ${val("D1_retained_users")},\n`;
           output += `            D7_retained_users: ${val("D7_retained_users")},\n`;
           output += `          },\n`;
        });
        
        // 如果不是最后一个月，加个逗号
        output += ` ]${index < keys.length - 1 ? ',' : ''}\n`;
      });
      
      document.getElementById('output').value = output;
    }
    
    function copyToClipboard() {
      const copyText = document.getElementById("output");
      if (!copyText.value) return;
      
      copyText.select();
      copyText.setSelectionRange(0, 999999); /* For mobile devices */
      
      navigator.clipboard.writeText(copyText.value).then(() => {
         const msg = document.getElementById("msg");
         msg.style.opacity = 1;
         setTimeout(() => msg.style.opacity = 0, 2000);
      }).catch(err => {
         console.error('Failed to copy: ', err);
         alert("复制失败，请手动复制。");
      });
    }
  </script>
</body>
</html>
