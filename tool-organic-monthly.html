<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>月自然量 Excel → JS 源数据处理工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --border: #e5e7eb;
      --border-soft: #d1d5db;
      --text-main: #111827;
      --text-sub: #6b7280;
      --accent: #0ea5e9;
      --accent-soft: rgba(14,165,233,0.08);
      --accent-strong: #0284c7;
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft Yahei",sans-serif;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 16px;
      padding: 16px 18px 12px;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(148,163,184,0.25);
    }

    .header-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .header-sub {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 6px;
    }

    .header-note {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .badge-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid #cbd5f5;
      background: #eef2ff;
      color: #4f46e5;
    }

    .card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: 0 6px 16px rgba(15,23,42,0.06);
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 260px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      color: #111827;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .file-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .file-input {
      font-size: 11px;
      color: var(--text-main);
    }

    input[type="file"] {
      max-width: 260px;
    }

    .btn-copy,
    .btn-generate {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
    }

    .btn-copy {
      border-color: var(--border-soft);
      color: var(--text-sub);
      background: #f9fafb;
    }

    .btn-copy:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .btn-generate {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .btn-generate:hover {
      background: rgba(14,165,233,0.16);
      border-color: var(--accent-strong);
    }

    .output {
      flex: 1;
      min-height: 200px;
      margin-top: 4px;
    }

    textarea {
      width: 100%;
      height: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      color: var(--text-main);
      font-size: 11px;
      padding: 8px;
      resize: vertical;
      font-family: Menlo, Consolas, "SF Mono", monospace;
      line-height: 1.5;
      outline: none;
      white-space: pre;
    }

    textarea::placeholder {
      color: #9ca3af;
    }

    .hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.5;
    }

    .hint strong {
      color: #111827;
    }

    .footer {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
      border-top: 1px dashed var(--border-soft);
      padding-top: 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="header">
      <div class="header-title">月自然量 Excel → JS 源数据处理工具</div>
      <div class="header-sub">
        上传某个月的自然量 Excel，点击「生成自然量 code」，得到可以直接粘贴到
        <code>RAW_ORGANIC_BY_MONTH</code> 的 <code>"YYYY-MM": [ { ... } ]</code> 片段。
      </div>
      <div class="header-note">
        · sheet 名默认 <strong>zrl_country_monthly</strong>，第 1 行为字段名，至少包含
        <code>date</code> / <code>country</code> / <code>registration</code> /
        <code>D0_unique_purchase</code> / <code>D0_SPORTS_BET_FLOW</code> 等列。<br />
        · 工具按 <code>date</code> 自动分组为多个 <code>"YYYY-MM"</code> 段，字段名与看板中使用的一致。
      </div>
      <div class="badge-row">
        <span class="badge">白色背景 · 纯前端 · 直接丢 GitHub Pages</span>
        <span class="badge">字段名使用英文，与示例 code 对齐</span>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">自然量单月数据 → JS 片段</div>
            <div class="card-sub">
              输出格式：<code>"YYYY-MM": [ { date, country, registration, ... } ]</code>，
              直接粘贴到 <code>RAW_ORGANIC_BY_MONTH</code> 内部。
            </div>
          </div>
          <button type="button" class="btn-copy" id="copy-org">复制自然量 code</button>
        </div>

        <div class="file-row">
          <span>自然量 Excel：</span>
          <input type="file" id="organic-file" class="file-input" accept=".xlsx,.xls" />
          <button type="button" class="btn-generate" id="gen-org">生成自然量 code</button>
        </div>

        <div class="hint">
          · 要求：表头至少包含 <strong>date</strong>、<strong>country</strong>、
          <strong>registration</strong>、<strong>D0_unique_purchase</strong>、
          <strong>D0_SPORTS_BET_FLOW</strong> 等英文字段。<br />
          · 如一个文件包含多个月数据，会按日期自动拆成多段 <code>"YYYY-MM": [ ... ]</code>。
        </div>

        <div class="output">
          <textarea
            id="organic-output"
            placeholder='上传自然量 Excel 后，点击「生成自然量 code」，这里会生成类似：

// ===== 2025-10 自然量（粘贴到 RAW_ORGANIC_BY_MONTH 对象里） =====
"2025-10": [
  {
    date: "2025-10-01", // YYYY-MM-DD
    country: "GH", // GH / KE / NG / TZ / UG

    // 注册 & 付费（D0）
    registration: 302,
    D0_unique_purchase: 138,
    D0_PURCHASE_VALUE: 561.46,

    // 投注人数（D0）
    D0_TOTAL_BET_PLACED_USER: 139,
    D0_SPORTS_BET_PLACED_USER: 64,
    D0_GAMES_BET_PLACED_USER: 104,

    // 流水（D0）
    D0_SPORTS_BET_FLOW: 93.48,
    D0_GAMES_BET_FLOW: 2211.0,
    D0_TOTAL_BET_FLOW: 2304.49,

    // 付费 & 投注（D7）
    D7_unique_purchase: 172,
    D7_PURCHASE_VALUE: 3002.0,
    D7_TOTAL_BET_PLACED_USER: 177,
    D7_SPORTS_BET_PLACED_USER: 108,
    D7_GAMES_BET_PLACED_USER: 138,

    // 流水（D7）
    D7_SPORTS_BET_FLOW: 532.02,
    D7_GAMES_BET_FLOW: 16393.33,
    D7_TOTAL_BET_FLOW: 16925.36,

    // 留存
    D1_retained_users: 139,
    D7_retained_users: 61,
  }
]'
          ></textarea>
        </div>
      </section>
    </main>

    <footer class="footer">
      使用建议：每月导出自然量 Excel 后，用本页面生成对应月份 JS 片段，直接粘贴到月自然量看板的数据源区域。
    </footer>
  </div>

  <!-- XLSX 解析库：在线 CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // 数字格式化：尽量还原整数 / 两位小数
    function formatJsNumber(value) {
      if (value === null || value === undefined || value === "") return "0";
      var num = Number(value);
      if (!Number.isFinite(num)) return "0";
      if (Math.abs(num - Math.round(num)) < 1e-9) {
        return String(Math.round(num));
      }
      return num.toFixed(2).replace(/\.00$/, "");
    }

    // 通用日期格式化，避免时区影响
    function normalizeDateCell(v) {
      if (v === null || v === undefined || v === "") return null;

      // JS Date 对象
      if (v instanceof Date) {
        var y = v.getFullYear();
        var m = String(v.getMonth() + 1).padStart(2, "0");
        var d = String(v.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + d;
      }

      // 纯数字（Excel 底层日期）
      if (typeof v === "number") {
        if (typeof XLSX !== "undefined" && XLSX.SSF && XLSX.SSF.parse_date_code) {
          var o = XLSX.SSF.parse_date_code(v);
          if (o && o.y && o.m && o.d) {
            var y2 = o.y;
            var m2 = String(o.m).padStart(2, "0");
            var d2 = String(o.d).padStart(2, "0");
            return y2 + "-" + m2 + "-" + d2;
          }
        }
      }

      // 字符串日期，如 "2025-10-01" 或 "2025/10/01 00:00:00"
      if (typeof v === "string") {
        var m = v.match(/(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
        if (m) {
          var y3 = m[1];
          var m3 = String(parseInt(m[2], 10)).padStart(2, "0");
          var d3 = String(parseInt(m[3], 10)).padStart(2, "0");
          return y3 + "-" + m3 + "-" + d3;
        }
      }

      return null;
    }

    // 只处理自然量：字段名使用英文表头
    function buildOrganicCode(workbook) {
      var sheet =
        workbook.Sheets["zrl_country_monthly"] || workbook.Sheets[workbook.SheetNames[0]];
      if (!sheet) {
        return "// 未找到 sheet：zrl_country_monthly（或第一个 sheet 为空）";
      }

      // 直接按字段名输出对象，每行是一个 { date, country, registration, ... }
      var rows = XLSX.utils.sheet_to_json(sheet, { defval: null });
      if (!rows || !rows.length) {
        return "// 表内没有数据";
      }

      var monthMap = {};

      rows.forEach(function (row) {
        var dateStr = normalizeDateCell(row.date);
        if (!dateStr) return;

        var rawCountry = row.country;
        if (!rawCountry) return;
        var country = String(rawCountry).trim().toUpperCase();

        var monthKey = dateStr.slice(0, 7);

        var lines = [];
        lines.push("  {");
        lines.push('    date: "' + dateStr + '", // YYYY-MM-DD');
        lines.push('    country: "' + country + '", // GH / KE / NG / TZ / UG');
        lines.push("");
        lines.push("    // 注册 & 付费（D0）");
        lines.push("    registration: " + formatJsNumber(row.registration) + ",");
        lines.push(
          "    D0_unique_purchase: " + formatJsNumber(row.D0_unique_purchase) + ","
        );
        lines.push(
          "    D0_PURCHASE_VALUE: " + formatJsNumber(row.D0_PURCHASE_VALUE) + ","
        );
        lines.push("");
        lines.push("    // 投注人数（D0）");
        lines.push(
          "    D0_TOTAL_BET_PLACED_USER: " +
            formatJsNumber(row.D0_TOTAL_BET_PLACED_USER) +
            ","
        );
        lines.push(
          "    D0_SPORTS_BET_PLACED_USER: " +
            formatJsNumber(row.D0_SPORTS_BET_PLACED_USER) +
            ","
        );
        lines.push(
          "    D0_GAMES_BET_PLACED_USER: " +
            formatJsNumber(row.D0_GAMES_BET_PLACED_USER) +
            ","
        );
        lines.push("");
        lines.push("    // 流水（D0）");
        lines.push(
          "    D0_SPORTS_BET_FLOW: " + formatJsNumber(row.D0_SPORTS_BET_FLOW) + ","
        );
        lines.push(
          "    D0_GAMES_BET_FLOW: " + formatJsNumber(row.D0_GAMES_BET_FLOW) + ","
        );
        lines.push(
          "    D0_TOTAL_BET_FLOW: " + formatJsNumber(row.D0_TOTAL_BET_FLOW) + ","
        );
        lines.push("");
        lines.push("    // 付费 & 投注（D7）");
        lines.push(
          "    D7_unique_purchase: " + formatJsNumber(row.D7_unique_purchase) + ","
        );
        lines.push(
          "    D7_PURCHASE_VALUE: " + formatJsNumber(row.D7_PURCHASE_VALUE) + ","
        );
        lines.push(
          "    D7_TOTAL_BET_PLACED_USER: " +
            formatJsNumber(row.D7_TOTAL_BET_PLACED_USER) +
            ","
        );
        lines.push(
          "    D7_SPORTS_BET_PLACED_USER: " +
            formatJsNumber(row.D7_SPORTS_BET_PLACED_USER) +
            ","
        );
        lines.push(
          "    D7_GAMES_BET_PLACED_USER: " +
            formatJsNumber(row.D7_GAMES_BET_PLACED_USER) +
            ","
        );
        lines.push("");
        lines.push("    // 流水（D7）");
        lines.push(
          "    D7_SPORTS_BET_FLOW: " + formatJsNumber(row.D7_SPORTS_BET_FLOW) + ","
        );
        lines.push(
          "    D7_GAMES_BET_FLOW: " + formatJsNumber(row.D7_GAMES_BET_FLOW) + ","
        );
        lines.push(
          "    D7_TOTAL_BET_FLOW: " + formatJsNumber(row.D7_TOTAL_BET_FLOW) + ","
        );
        lines.push("");
        lines.push("    // 留存");
        lines.push(
          "    D1_retained_users: " + formatJsNumber(row.D1_retained_users) + ","
        );
        lines.push(
          "    D7_retained_users: " + formatJsNumber(row.D7_retained_users) + ","
        );
        lines.push("  }");

        if (!monthMap[monthKey]) monthMap[monthKey] = [];
        monthMap[monthKey].push(lines.join("\n"));
      });

      var monthKeys = Object.keys(monthMap).sort();
      if (!monthKeys.length) {
        return "// 没读到任何有效自然量数据行";
      }

      var out = [];
      monthKeys.forEach(function (mk, idx) {
        out.push(
          "// ===== " + mk + " 自然量（粘贴到 RAW_ORGANIC_BY_MONTH 对象里） ====="
        );
        out.push('"' + mk + '": [');
        out.push(monthMap[mk].join(",\n\n"));
        out.push("]");
        if (idx < monthKeys.length - 1) {
          out.push("");
          out.push("");
        }
      });

      return out.join("\n");
    }

    function readWorkbookFromFile(file, onDone) {
      var reader = new FileReader();
      reader.onload = function (evt) {
        try {
          var data = evt.target.result;
          var wb = XLSX.read(data, { type: "array" });
          onDone(null, wb);
        } catch (err) {
          onDone(err || new Error("解析 Excel 出错"));
        }
      };
      reader.onerror = function (err) {
        onDone(err || new Error("读取文件失败"));
      };
      reader.readAsArrayBuffer(file);
    }

    function bindCopyButton(btnId, textareaId) {
      var btn = document.getElementById(btnId);
      var ta = document.getElementById(textareaId);
      if (!btn || !ta) return;

      btn.addEventListener("click", function () {
        if (!ta.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(ta.value).catch(function () {});
        } else {
          ta.select();
          document.execCommand("copy");
        }
      });
    }

    function bindGenerateButton() {
      var orgBtn = document.getElementById("gen-org");
      var orgInput = document.getElementById("organic-file");
      var orgOut = document.getElementById("organic-output");

      if (orgBtn && orgInput && orgOut) {
        orgBtn.addEventListener("click", function () {
          orgOut.value = "";
          if (!orgInput.files || !orgInput.files[0]) {
            orgOut.value = "// 请先选择自然量 Excel 文件";
            return;
          }
          readWorkbookFromFile(orgInput.files[0], function (err, wb) {
            if (err) {
              orgOut.value =
                "// 解析自然量 Excel 出错：\n// " + (err.message || String(err));
              return;
            }
            orgOut.value = buildOrganicCode(wb);
          });
        });
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      bindGenerateButton();
      bindCopyButton("copy-org", "organic-output");
    });
  </script>
</body>
</html>
